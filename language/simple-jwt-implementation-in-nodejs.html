
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Node.js 的简单 JWT 实现 · 每周翻译计划</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="JalanJiang.江子抑 <jjy@meitu.com>">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-twilight.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.html" />
    
    
    <link rel="prev" href="types-are-moving-to-the-right.html" />
    

    
        <link rel="shortcut icon" href='../favicon.ico' type="image/x-icon">
    
    
        <link rel="bookmark" href='../favicon.ico' type="image/x-icon">
    
    
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"JalanJiang","repo":"weekly-translation","type":"star","size":"small"}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="http://jalan.space" target="_blank" class="custom-link">我的博客</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>1.1.</b>
                    
                    简介
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">编程语言</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="types-are-moving-to-the-right.html">
            
                <a href="types-are-moving-to-the-right.html">
            
                    
                        <b>2.1.</b>
                    
                    类型声明右移的原因
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.2" data-path="simple-jwt-implementation-in-nodejs.html">
            
                <a href="simple-jwt-implementation-in-nodejs.html">
            
                    
                        <b>2.2.</b>
                    
                    Node.js 的简单 JWT 实现
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">其他</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.html">
            
                <a href="../other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.html">
            
                    
                        <b>3.1.</b>
                    
                    日志记录的最佳实践
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../other/the-downsides-of-json-for-config-files.html">
            
                <a href="../other/the-downsides-of-json-for-config-files.html">
            
                    
                        <b>3.2.</b>
                    
                    用 JSON 作为配置文件的缺陷
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Node.js 的简单 JWT 实现</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <ul>
<li>&#x539F;&#x6587;&#xFF1A;<a href="https://guseyn.com/posts/simple-jwt?v=1.0.85" target="_blank">Simple JWT Implementation in Node.js: Symmetric Variation</a></li>
<li>&#x4F5C;&#x8005;&#xFF1A;<a href="https://guseyn.com/" target="_blank">Guseyn Ismayylov</a></li>
<li>&#x7FFB;&#x8BD1;&#xFF1A;<a href="http://gagalee.ink" target="_blank">Gaga Lee</a></li>
</ul>
<blockquote>
<p>In this article, I&apos;ll explain how easily you can implement authorization and authentication via JWT using only standard modules in Node.js. So, it might be interesting to you, if you really want to know how it works.</p>
</blockquote>
<p>&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4F1A;&#x89E3;&#x91CA;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x53EA;&#x4F7F;&#x7528; Node.js &#x91CC;&#x7684;&#x6807;&#x51C6;&#x6A21;&#x5757;&#x6765;&#x5B9E;&#x73B0;&#x6388;&#x6743;&#x548C;&#x901A;&#x8FC7; JWT &#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x8FD9;&#x6216;&#x8BB8;&#x5BF9;&#x4F60;&#x6765;&#x8BF4;&#x5F88;&#x6709;&#x8DA3;&#xFF0C;&#x6211;&#x5E0C;&#x671B;&#x4F60;&#x4F1A;&#x77E5;&#x9053;&#x5B83;&#x662F;&#x600E;&#x4E48;&#x5DE5;&#x4F5C;&#x7684;&#x3002;</p>
<blockquote>
<p>If you don&apos;t know what JWT is, you can read this article first. In few words, JWT is a JSON-based open standard for creating access tokens. Let&apos;s say you have a system with some REST API, and you want to securily detect a user who calls methods from this API. JWT is quite simple and effective solution for this problem.</p>
</blockquote>
<p>&#x5982;&#x679C;&#x4F60;&#x5E76;&#x4E0D;&#x77E5;&#x9053; JWT &#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5148;&#x9605;&#x8BFB;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x3002;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;JWT &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x6765;&#x521B;&#x5EFA;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x57FA;&#x4E8E; JSON &#x7684;&#x516C;&#x5F00;&#x6807;&#x51C6;&#x3002;&#x5047;&#x8BBE;&#x4F60;&#x6709;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x90E8;&#x5206; REST API &#x7684;&#x7CFB;&#x7EDF;,&#x800C;&#x4E14;&#x4F60;&#x60F3;&#x8981;&#x68C0;&#x6D4B;&#x8C03;&#x7528;&#x8FD9;&#x4E9B; API &#x7684;&#x7528;&#x6237;&#x662F;&#x5426;&#x662F;&#x5B89;&#x5168;&#x7684;&#x3002;JWT &#x4F1A;&#x662F;&#x4E00;&#x4E2A;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#x800C;&#x4E14;&#x6709;&#x6548;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;</p>
<blockquote>
<p>JWT is a string that has following format:</p>
</blockquote>
<p>JWT &#x662F;&#x4E00;&#x4E32;&#x5982;&#x4E0B;&#x65B9;&#x6240;&#x793A;&#x683C;&#x5F0F;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;</p>
<pre class="language-"><code>&apos;encodedHeaderInBase64.encodedPayloadInBase64.encodedSignatureInBase64&apos;
</code></pre><blockquote>
<p>Let&apos;s go through typical workflow of using JWT.</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x6765;&#x4E86;&#x89E3;&#x4E0B;&#x4F7F;&#x7528; JWT &#x7684;&#x5178;&#x578B;&#x5DE5;&#x4F5C;&#x6D41;&#x3002;</p>
<blockquote>
<ol>
<li>User signs in a system with some sensitive data like password and simple user data like email or user name. After successfull authentication user gets an access token from server. This token has expiration time, so user cannot use it forever.</li>
</ol>
</blockquote>
<ol>
<li>&#x7528;&#x6237;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x654F;&#x611F;&#x6570;&#x636E;&#x6BD4;&#x5982;&#x5BC6;&#x7801;&#x548C;&#x666E;&#x901A;&#x7684;&#x7528;&#x6237;&#x6570;&#x636E;&#x6BD4;&#x5982;&#x90AE;&#x7BB1;&#x6216;&#x8005;&#x8D26;&#x6237;&#x540D;&#x6765;&#x767B;&#x5F55;&#x7CFB;&#x7EDF;&#x3002;&#x5728;&#x6210;&#x529F;&#x7684;&#x6388;&#x6743;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x83B7;&#x5F97;&#x4E86;&#x4E00;&#x4E2A;&#x4EE4;&#x724C;&#x3002;&#x8FD9;&#x4E2A;&#x4EE4;&#x724C;&#x5177;&#x6709;&#x751F;&#x6548;&#x65F6;&#x95F4;&#xFF0C;&#x6240;&#x4EE5;&#x7528;&#x6237;&#x4E0D;&#x80FD;&#x6C38;&#x4E45;&#x5730;&#x4F7F;&#x7528;&#x5B83;&#x3002;</li>
</ol>
<blockquote>
<ol>
<li>We save it to local storage, so user can always have it for calling REST API methods.</li>
</ol>
</blockquote>
<ol>
<li>&#x6211;&#x4EEC;&#x5C06;&#x5B83;&#x4FDD;&#x5B58;&#x5728;&#x672C;&#x5730;&#x7684;&#x5B58;&#x50A8;&#x5185;&#xFF0C;&#x56E0;&#x6B64;&#x7528;&#x6237;&#x603B;&#x662F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5B83;&#x6765;&#x8BBF;&#x95EE; REST API &#x7684;&#x65B9;&#x6CD5;&#x3002;</li>
</ol>
<blockquote>
<ol>
<li>Every time user calls a method from API, we send JWT in headers of request and server verifies that token. If it&apos;s valid we are allowed to use API method, otherwise we must sign in the system again to get new access token. It&apos;s important to use secure protocols like https, because JWT is sensitive data.</li>
</ol>
</blockquote>
<ol>
<li>&#x6BCF;&#x6B21;&#x7528;&#x6237;&#x4ECE; API &#x4E2D;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x8BF7;&#x6C42;&#x7684;&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#x53D1;&#x9001; JWT &#xFF0C;&#x7136;&#x540E;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x8BC6;&#x522B;&#x8FD9;&#x4E2A;&#x4EE4;&#x724C;&#x3002;&#x5982;&#x679C;&#x5B83;&#x662F;&#x5B58;&#x5728;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x4F7F;&#x7528; API &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x5FC5;&#x987B;&#x518D;&#x6B21;&#x767B;&#x5F55;&#x7CFB;&#x7EDF;&#x53BB;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;&#x4F7F;&#x7528;&#x5B89;&#x5168;&#x7684;&#x534F;&#x8BAE;&#x5982; https &#x662F;&#x5341;&#x5206;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x56E0;&#x4E3A; JWT &#x662F;&#x654F;&#x611F;&#x6570;&#x636E;&#x3002;</li>
</ol>
<blockquote>
<ol>
<li>If you signs out the system, we delete access token from local storage.</li>
</ol>
</blockquote>
<ol>
<li>&#x5982;&#x679C;&#x4F60;&#x767B;&#x51FA;&#x7CFB;&#x7EDF;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x4ECE;&#x672C;&#x5730;&#x5B58;&#x50A8;&#x4E2D;&#x5220;&#x9664;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</li>
</ol>
<blockquote>
<p>For creating JWT we need two objects: header and payload.</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x521B;&#x5EFA; JWT&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E24;&#x4E2A;&#x5BF9;&#x8C61;&#xFF1A;&#x5934;&#x6587;&#x4EF6;&#x548C;&#x8D1F;&#x8F7D;&#x6587;&#x4EF6;&#x3002;</p>
<blockquote>
<p>Header is a simple json:</p>
</blockquote>
<p>&#x5934;&#x6587;&#x4EF6;&#x662F;&#x4E00;&#x6BB5;&#x7B80;&#x5355;&#x7684; json&#x3002;</p>
<pre class="language-"><code>{
 &quot;alg&quot; : &quot;HS256&quot;,
 &quot;type&quot; : &quot;JWT&quot;
}
</code></pre><blockquote>
<p><strong>alg</strong> identifies which algorithm is used to generate the signature, and <strong>type</strong> tell us that we use JSON Web Token. I would recommend you to hardcode this object as a header, if you want to use symmetric algorithms. I don&apos;t see any other reason to parametrize this object, so you can avoid a lot of checks on alg property and reduce complexity of your code. Or you can use asymmetric algorithms such as <strong>RS256</strong>, and allow your users to identify themselves via their public keys. But in this article we will consider only symmetric approach (<strong>HS256</strong>).</p>
</blockquote>
<p><strong>alg</strong> &#x7528;&#x6765;&#x786E;&#x8BA4;&#x4F7F;&#x7528;&#x54EA;&#x4E00;&#x79CD;&#x7B97;&#x6CD5;&#x6765;&#x751F;&#x6210;&#x7B7E;&#x540D;&#xFF0C;<strong>type</strong> &#x544A;&#x77E5;&#x6211;&#x4EEC;&#xFF0C;&#x5C06;&#x4F7F;&#x7528; JSON Web &#x4EE4;&#x724C;&#x3002;&#x6211;&#x5EFA;&#x8BAE;&#x4F60;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x786C;&#x7F16;&#x7801;&#x4E3A;&#x4E00;&#x4E2A;&#x5934;&#x6587;&#x4EF6;&#xFF0C;&#x5047;&#x5982;&#x4F60;&#x60F3;&#x8981;&#x4F7F;&#x7528;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#x3002;&#x6211;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x5176;&#x4ED6;&#x7684;&#x7406;&#x7531;&#x9700;&#x8981;&#x53BB;&#x53C2;&#x6570;&#x5316;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x4F60;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x4E00;&#x5927;&#x5806;&#x7684;&#x5BF9;&#x4E8E; alg &#x5C5E;&#x6027;&#x7684;&#x786E;&#x8BA4;&#xFF0C;&#x5E76;&#x964D;&#x4F4E;&#x4F60;&#x4EE3;&#x7801;&#x7684;&#x590D;&#x6742;&#x5EA6;&#x3002;&#x6216;&#x8005;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E; <strong>RS256</strong> &#x7684;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF0C;&#x5E76;&#x5141;&#x8BB8;&#x4F60;&#x7684;&#x7528;&#x6237;&#x901A;&#x8FC7;&#x4ED6;&#x4EEC;&#x7684;&#x516C;&#x94A5;&#x53BB;&#x8BC6;&#x522B;&#x4ED6;&#x4EEC;&#x81EA;&#x5DF1;&#x3002;&#x4E0D;&#x8FC7;&#x5728;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x91CC;&#x6211;&#x4EEC;&#x5C06;&#x53EA;&#x8003;&#x8651;&#x5BF9;&#x79F0;&#x7684;&#x65B9;&#x6CD5;&#xFF08;<strong>HS256</strong>&#xFF09;&#x3002;</p>
<blockquote>
<p><strong>Payload</strong> is an object that identifies your user, so it has to contain unique data for specific user like email. It can also store some other user data, but you definetely shouldn&apos;t store there sensitive information like password. Also, it&apos;s useful to store expiration time of access token there.</p>
</blockquote>
<p><strong>Payload</strong> &#x662F;&#x4E00;&#x4E2A;&#x7528;&#x6765;&#x8BC6;&#x522B;&#x4F60;&#x7684;&#x7528;&#x6237;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5FC5;&#x987B;&#x5305;&#x542B;&#x7279;&#x5B9A;&#x7528;&#x6237;&#x7684;&#x552F;&#x4E00;&#x6570;&#x636E;&#x5982;&#x90AE;&#x7BB1;&#x3002;&#x5B83;&#x540C;&#x6837;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x4E00;&#x4E9B;&#x7528;&#x6237;&#x7684;&#x5176;&#x4ED6;&#x6570;&#x636E;&#xFF0C;&#x4E0D;&#x8FC7;&#x4F60;&#x7EDD;&#x5BF9;&#x4E0D;&#x80FD;&#x5B58;&#x50A8;&#x4E00;&#x4E9B;&#x654F;&#x611F;&#x6570;&#x636E;&#x5982;&#x5BC6;&#x7801;&#x3002;&#x9664;&#x6B64;&#x4E4B;&#x5916;&#xFF0C;&#x5728;&#x8FD9;&#x5B58;&#x50A8;&#x4EE4;&#x724C;&#x7684;&#x6709;&#x6548;&#x65F6;&#x95F4;&#x5C06;&#x4F1A;&#x662F;&#x4E00;&#x4E2A;&#x597D;&#x7528;&#x7684;&#x529E;&#x6CD5;&#x3002;</p>
<pre class="language-"><code>{
  &quot;email&quot;: &quot;some@email&quot;,
  &quot;exp&quot;: 1554540588448
}
</code></pre><blockquote>
<p>You can use following function to add expiration time to your payload:</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0B;&#x65B9;&#x7684;&#x51FD;&#x6570;&#x6765;&#x4E3A;&#x4F60;&#x7684;&#x8D1F;&#x8F7D;&#x589E;&#x52A0;&#x6709;&#x6548;&#x65F6;&#x95F4;&#x3002;</p>
<pre class="language-"><code>function payloadWithExpirationTime (payload, minutesFromNow) {
  let date = new Date()
  date.setMinutes(date.getMinutes() + minutesFromNow)
  payload.exp = date.getTime()
  return payload
}
</code></pre><blockquote>
<p>You might wonder why some property names are just three charatecrs long. I have no idea. I read that&apos;s sort of some optimisations, but I don&apos;t think that&apos;s so important.</p>
</blockquote>
<p>&#x4F60;&#x6216;&#x8BB8;&#x4F1A;&#x7591;&#x60D1;&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x4E9B;&#x5C5E;&#x6027;&#x540D;&#x79F0;&#x53EA;&#x6709;&#x4E09;&#x4E2A;&#x5B57;&#x7B26;&#x7684;&#x957F;&#x5EA6;&#x3002;&#x6211;&#x4E5F;&#x4E0D;&#x6E05;&#x695A;&#x3002;&#x6211;&#x9605;&#x8BFB;&#x540E;&#x4E86;&#x89E3;&#x90A3;&#x662F;&#x90E8;&#x5206;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x4E0D;&#x8FC7;&#x6211;&#x8BA4;&#x4E3A;&#x90A3;&#x662F;&#x4E0D;&#x91CD;&#x8981;&#x7684;&#x3002;</p>
<blockquote>
<p>So, we have header and payload as json structures. And we need to convert them in base64 encoded strings. For doing this, use following function:</p>
</blockquote>
<p>&#x6240;&#x4EE5;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x4E86; json &#x7ED3;&#x6784;&#x7684;&#x5934;&#x90E8;&#x6587;&#x4EF6;&#x548C;&#x8D1F;&#x8F7D;&#x6587;&#x4EF6;&#x3002;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x53BB;&#x5C06;&#x4ED6;&#x4EEC;&#x8F6C;&#x6362;&#x6210; 64 &#x4F4D;&#x7F16;&#x7801;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x4E3A;&#x4E86;&#x5B8C;&#x6210;&#x8FD9;&#x4E2A;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x7684;&#x51FD;&#x6570;&#xFF1A;</p>
<pre class="language-"><code>function base64UrlEncodeJSON (json) {
  return Buffer.from(
    JSON.stringify(json)
  ).toString(&apos;base64&apos;)
   .replace(/\+/g, &apos;-&apos;)
   .replace(/\//g, &apos;_&apos;)
}
</code></pre><blockquote>
<p>Now we have to generate a signature for our token. For doing that, we need a some secret. It&apos;s a just simple string that only your server knows and it&apos;s very important to not compromise it.</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x4EE4;&#x724C;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x7B7E;&#x540D;&#x3002;&#x4E3A;&#x4E86;&#x505A;&#x8FD9;&#x4E2A;&#x4E8B;&#x60C5;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x5C0F;&#x8BB8;&#x7684;&#x4E0D;&#x516C;&#x5F00;&#x7684;&#x5185;&#x5BB9;&#x3002;
&#x8FD9;&#x53EA;&#x662F;&#x4E00;&#x4E32;&#x53EA;&#x6709;&#x4F60;&#x7684;&#x670D;&#x52A1;&#x5668;&#x77E5;&#x9053;&#x7684;&#x7B80;&#x5355;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x800C;&#x4E14;&#x7B26;&#x5408;&#x89C4;&#x5219;&#x662F;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x3002;</p>
<blockquote>
<p>Use following function to generate a signature:</p>
</blockquote>
<p>&#x4F7F;&#x7528;&#x4E0B;&#x65B9;&#x7684;&#x51FD;&#x6570;&#x6765;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x7B7E;&#x540D;&#xFF1A;</p>
<pre class="language-"><code>const crypto = require(&apos;crypto&apos;)

function generateSignature (str, secret) {
  return crypto
      .createHmac(&apos;sha256&apos;, secret)
      .update(str)
      .digest(&apos;base64&apos;)
      .replace(/\+/g, &apos;-&apos;)
      .replace(/\//g, &apos;_&apos;)
}
</code></pre><blockquote>
<p>Function <strong>generateSignature</strong> also encodes string to base64.</p>
</blockquote>
<p><strong>generateSignature</strong> &#x51FD;&#x6570;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x7F16;&#x7801;&#x4E3A;64&#x4F4D;&#x7684;&#x3002;</p>
<blockquote>
<p>So, for creating our access token we do something like this:</p>
</blockquote>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x4E3A;&#x4E86;&#x521B;&#x5EFA;&#x6211;&#x4EEC;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x505A;&#x4EE5;&#x4E0B;&#x7684;&#x4E8B;&#x60C5;&#xFF1A;</p>
<pre class="language-"><code>const encodedHeaderInBase64 = base64UrlEncodeJSON(header)
const encodedPayloadInBase64 = base64UrlEncodeJSON(payload)
const encodedSignatureInBase64 = generateSignature(`${encodedHeaderInBase64}.${encodedPayloadInBase64}`, &apos;some-secret&apos;)
const token = `${encodedHeaderInBase64}.${encodedPayloadInBase64}.${encodedSignatureInBase64}`
</code></pre><blockquote>
<p>Now we need to be able to verify our token from &apos;Authorization&apos; request header:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x80FD;&#x591F;&#x53BB;&#x8FA8;&#x522B;&#x6211;&#x4EEC;&#x4ECE;&#x201C;&#x6388;&#x6743;&#x201D;&#x7684;&#x8BF7;&#x6C42;&#x5934;&#x6587;&#x4EF6;&#x83B7;&#x5F97;&#x7684;&#x4EE4;&#x724C;&#x3002;</p>
<pre class="language-"><code>// Returns true if token is valid, otherwise returns false
// &#x5982;&#x679C;&#x83B7;&#x53D6;&#x7684;&#x5185;&#x5BB9;&#x5B58;&#x5728;&#x5219;&#x8FD4;&#x56DE;true,&#x9664;&#x6B64;&#x4E4B;&#x5916;&#x8FD4;&#x56DE;false
function isValid (token, secret) {
  const parts = token.split(&apos;.&apos;)
  const header = base64UrlDecodeToJSON(parts[0])
  const payload = base64UrlDecodeToJSON(parts[1])
  if (header.alg !== &apos;HS256&apos; || header.typ !== &apos;JWT&apos;) {
    return false
  }
  const signature = parts[2]
  const exp = payload.exp
  if (exp) {
    if (exp &lt; new Date().getTime()) {
      return false
    }
  }
  return generateSignature(`${parts[0]}.${parts[1]}`, secret) === signature
}
function base64UrlDecodeToJSON (str) {
  return JSON.parse(
    Buffer.from(
      str.replace(/-/g, &apos;+&apos;).replace(/_/g, &apos;/&apos;), &apos;base64&apos;
    ).toString(&apos;utf8&apos;)
  )
}
</code></pre><blockquote>
<p>For testing your access token I would suggest this service.</p>
</blockquote>
<p>&#x6211;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#x6765;&#x6D4B;&#x8BD5;&#x4F60;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</p>
<blockquote>
<p>So, that&apos;s it. You can also check this sample app that can show how you can use JWT with Google OAuth and GitHub OAuth.</p>
</blockquote>
<p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x5168;&#x90E8;&#x4E86;&#x3002;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x8FD9;&#x4E2A;&#x793A;&#x4F8B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x6765;&#x770B;&#x5982;&#x4F55;&#x4F7F;&#x7528; JWT &#x6765;&#x8FDB;&#x884C; Google &#x6388;&#x6743;&#x548C; GitHub &#x6388;&#x6743;&#x3002;</p>
<hr>
<blockquote>
<p>References</p>
</blockquote>
<p>&#x53C2;&#x8003;&#x6587;&#x732E;</p>
<ul>
<li><a href="https://jwt.io/" target="_blank">JWT.io</a></li>
<li><a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="_blank">JSON Web Token</a></li>
<li><a href="https://github.com/Guseyn/simple-oauth-app" target="_blank">Sample app using JWT with Google OAuth and GitHub OAuth</a></li>
</ul>
<hr>
<p>&#x7FFB;&#x8BD1;&#x751F;&#x8BCD;&#xFF1A;</p>
<ol>
<li><p>implement</p>
<blockquote>
<p>n. &#x5DE5;&#x5177;&#xFF0C;&#x5668;&#x5177;&#xFF1B;&#x624B;&#x6BB5;<br>vt. &#x5B9E;&#x65BD;&#xFF0C;&#x6267;&#x884C;&#xFF1B;&#x5B9E;&#x73B0;&#xFF0C;&#x4F7F;&#x751F;&#x6548;</p>
</blockquote>
</li>
<li><p>Let&apos;s say </p>
<blockquote>
<p>&#x5047;&#x8BBE;</p>
</blockquote>
</li>
<li><p>optimisation</p>
<blockquote>
<p>&#x4F18;&#x5316;</p>
</blockquote>
</li>
<li><p>token</p>
<blockquote>
<p>n. &#x8868;&#x5F81;&#xFF1B;&#x4EE3;&#x5E01;&#xFF1B;&#x8BB0;&#x53F7;&#xFF1B;&#x901A;&#x8BC1;
adj. &#x8C61;&#x5F81;&#x7684;&#xFF1B;&#x8868;&#x610F;&#x7684;&#xFF1B;&#x4F5C;&#x4E3A;&#x5BF9;&#x67D0;&#x4E8B;&#x7684;&#x4FDD;&#x8BC1;&#x7684;
vt. &#x8C61;&#x5F81;&#xFF1B;&#x4EE3;&#x8868;</p>
</blockquote>
</li>
<li><p>signature</p>
<blockquote>
<p>n. &#x7F72;&#x540D;&#xFF1B;&#x7B7E;&#x540D;&#xFF1B;&#x4FE1;&#x53F7;</p>
</blockquote>
</li>
<li><p>protocols</p>
<blockquote>
<p>n. &#x534F;&#x8BAE;&#xFF1B;&#x793C;&#x4EEA;&#x793C;&#x8282;&#xFF1B;&#x6761;&#x6B3E;&#xFF08;protocol&#x7684;&#x590D;&#x6570;&#xFF09;
v. &#x62DF;&#x5B9A;&#x8BAE;&#x5B9A;&#x4E66;&#xFF1B;&#x62DF;&#x5B9A;&#x8349;&#x6848;&#xFF08;protocol&#x7684;&#x4E09;&#x5355;&#x5F62;&#x5F0F;&#xFF09;</p>
</blockquote>
</li>
<li><p>parametrize</p>
<blockquote>
<p>v. &#x7528;&#x53C2;&#x6570;&#x8868;&#x793A;&#xFF1B;&#x786E;&#x5B9A;&#x2026;&#x2026;&#x7684;&#x53C2;&#x6570; </p>
</blockquote>
</li>
</ol>
<footer class="page-footer"><span class="copyright">JalanJiang.&#x6C5F;&#x5B50;&#x6291; all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-05-18 13:54:17
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="types-are-moving-to-the-right.html" class="navigation navigation-prev " aria-label="Previous page: 类型声明右移的原因">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.html" class="navigation navigation-next " aria-label="Next page: 日志记录的最佳实践">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Node.js 的简单 JWT 实现","level":"2.2","depth":1,"next":{"title":"日志记录的最佳实践","level":"3.1","depth":1,"path":"other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.md","ref":"other/follow-these-logging-best-practices-to-get-the-most-out-of-application-level-logging-slides.md","articles":[]},"previous":{"title":"类型声明右移的原因","level":"2.1","depth":1,"path":"language/types-are-moving-to-the-right.md","ref":"language/types-are-moving-to-the-right.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-default","disqus","prism","-highlight","tbfed-pagefooter","github-buttons","page-toc-button","back-to-top-button","sitemap-general","favicon@^0.0.2","splitter","baiduana"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"JalanJiang.江子抑","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prismjs/themes/prism-twilight.css"]},"disqus":{"useIdentifier":false,"shortName":"jalanspace"},"splitter":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sitemap-general":{"prefix":"http://jalan.space/leetcode-notebook/"},"fontsettings":{"theme":"white","family":"sans","size":2},"fontSettings":{"theme":"sepia","family":"serif","size":2},"favicon":{"shortcut":"favicon.ico","bookmark":"favicon.ico"},"page-toc-button":{},"back-to-top-button":{},"github-buttons":{"buttons":[{"user":"JalanJiang","repo":"weekly-translation","type":"star","size":"small"}]},"baiduana":{},"baidu":{"token":"c47c7dbbbbb8b1bd7729048f358cd896"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"showLevel":true,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}}},"theme":"default","author":"JalanJiang.江子抑 <jjy@meitu.com>","pdf":{"pageBreaksBefore":"/","headerTemplate":null,"paperSize":"a4","margin":{"right":62,"left":62,"top":36,"bottom":36},"fontSize":12,"fontFamily":"Arial","footerTemplate":null,"chapterMark":"pagebreak","pageNumbers":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"isbn":"","variables":{},"title":"每周翻译计划","links":{"sidebar":{"我的博客":"http://jalan.space"},"sharing":{"google":null,"facebook":null,"twitter":null,"weibo":null,"all":null}},"gitbook":"*","description":"每周翻译一篇英文技术文章~","extension":""},"file":{"path":"language/simple-jwt-implementation-in-nodejs.md","mtime":"2019-05-18T05:54:17.725Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-18T06:02:29.661Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-baiduana/baidu_gitbook.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

